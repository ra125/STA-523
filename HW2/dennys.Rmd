---
title: "Dennys_noLoop"
author: "Sophie Lee"
date: "October 1, 2014"
output: html_document
---

Here, we are collecting Denny's location data. Since the location service provider for Denny's has a fairly high limit for radius, which is 1000 miles, we base the focal points for location collection in the following five states: Utah, DC, Kansas, Hawaii, and Alaska. 
```{r}

## load required packages

check_packages = function(names)
{
  for(name in names)
  {
    if (!(name %in% installed.packages()))
      install.packages(name, repos="http://cran.us.r-project.org")

    library(name, character.only=TRUE)
  }
}

check_packages(c("httr","XML","sp","stringr","jsonlite","rgeos","maptools", "rgdal","ggplot2","spatsta","jsonlite","stringr"))



dir.create("json/", showWarnings = FALSE)
key="8D6F0428-F3A9-11DD-8BF2-659237ABAA09"

###### states to go through!
names=c("UT","DC","KS","AL","HI")


################ Looping

for(i in names) {
  
name=i
url = paste0("http://hosted.where2getit.com/dennys/ajax?&xml_request=%3Crequest%3E%3Cappkey%3E",
             key,
             "%3C%2Fappkey%3E%3Cformdata+id%3D%22locatorsearch%22%3E%3Cdataview%3Estore_default%3C%2Fdataview%3E%3Climit%3E3000%3C%2Flimit%3E%3Cgeolocs%3E%3Cgeoloc%3E%3Caddressline%3E,%20",
             name,
             "%3C%2Faddressline%3E%3Clongitude%3E%3C%2Flongitude%3E%3Clatitude%3E%3C%2Flatitude%3E%3C%2Fgeoloc%3E%3C%2Fgeolocs%3E%3Csearchradius%3E3000|10000%3C%2Fsearchradius%3E%3C%2Fformdata%3E%3C%2Frequest%3E")   

d=GET(url)
stopifnot(d$status_code == 200)

# Clean up jQuery wrapper to get valid json
s = content(d, as="text")
each=as.character(str_match_all(s,"<name>(.*?)</uid>"))
uid=as.data.frame(str_match_all(each,"<uid>(.*?)</uid>"))
uid=as.data.frame(uid[1:1000,2])
state=as.data.frame(str_match_all(each,"<state>(.*?)</state>"))
state=as.data.frame(state[1:1000,2])
address=as.data.frame(str_match_all(each,"<address1>(.*?)</address1>"))
address=as.data.frame(address[1:1000,2])
phone=as.data.frame(str_match_all(each,"<phone>(.*?)</phone>"))
phone=as.data.frame(phone[1:1000,2])
lat=as.data.frame(str_match_all(each, "<latitude>([0-9.0-9]*)</latitude>"))
lat=as.data.frame(lat[1:1000,2])
long=as.data.frame(str_match_all(each,"<longitude>(-[0-9.0-9]*)</longitude>"))
long=as.data.frame(long[1:1000,2])

data=cbind("uid"=uid, "state"=state, "address"=address, "phone"=phone, "lat"=lat, "long"=long)
assign(i, data)

# Save the file locally
file = paste0("json/",name,".json")
write(s, file=file)

}





################### add them together and make the final data

data=rbind(data.UT, data.DC, data.AL, data.HI, data.KS)
data=unique(data)



table(data[,2]))






```



